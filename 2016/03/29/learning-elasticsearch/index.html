<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Learning ElasticSearch | Tranquility Garden</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Learning ElasticSearch最近在学习ElasticSearch，从底层的Lucene开始了解特别推荐这两本书，非常非常感谢社区的贡献，有机会还是支持出版的纸质书籍这篇文章等于是对这两本书阅读后做了摘要，方便零基础的用户快速上手ElasticSearchElasticsearch 权威指南（中文版）ELKstack 中文指南（ElasticSearch章节）  
ES vs SQL">
<meta property="og:type" content="article">
<meta property="og:title" content="Learning ElasticSearch">
<meta property="og:url" content="http://blog.wuliwala.net/2016/03/29/learning-elasticsearch/index.html">
<meta property="og:site_name" content="Tranquility Garden">
<meta property="og:description" content="Learning ElasticSearch最近在学习ElasticSearch，从底层的Lucene开始了解特别推荐这两本书，非常非常感谢社区的贡献，有机会还是支持出版的纸质书籍这篇文章等于是对这两本书阅读后做了摘要，方便零基础的用户快速上手ElasticSearchElasticsearch 权威指南（中文版）ELKstack 中文指南（ElasticSearch章节）  
ES vs SQL">
<meta property="og:updated_time" content="2016-04-01T03:30:26.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Learning ElasticSearch">
<meta name="twitter:description" content="Learning ElasticSearch最近在学习ElasticSearch，从底层的Lucene开始了解特别推荐这两本书，非常非常感谢社区的贡献，有机会还是支持出版的纸质书籍这篇文章等于是对这两本书阅读后做了摘要，方便零基础的用户快速上手ElasticSearchElasticsearch 权威指南（中文版）ELKstack 中文指南（ElasticSearch章节）  
ES vs SQL">
  
    <link rel="alternate" href="http://blog.wuliwala.net/atom.xml" title="Tranquility Garden" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
<!--  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css"> -->
  <link href="//fonts.useso.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-72217808-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Tranquility Garden</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="http://blog.wuliwala.net">Home</a>
        
          <a class="main-nav-link" href="http://blog.wuliwala.net/archives">Archives</a>
        
          <a class="main-nav-link" href="http://blog.wuliwala.net/about">About</a>
        
          <a class="main-nav-link" href="https://github.com/arkii">GitHub</a>
        
          <a class="main-nav-link" href="https://hub.docker.com/u/arkii">DockerHub</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="http://blog.wuliwala.net/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.wuliwala.net"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-learning-elasticsearch" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/03/29/learning-elasticsearch/" class="article-date">
  <time datetime="2016-03-29T02:42:00.000Z" itemprop="datePublished">2016-03-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/search/">search</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Learning ElasticSearch
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Learning-ElasticSearch"><a href="#Learning-ElasticSearch" class="headerlink" title="Learning ElasticSearch"></a>Learning ElasticSearch</h2><p>最近在学习ElasticSearch，从底层的Lucene开始了解<br>特别推荐这两本书，非常非常感谢社区的贡献，有机会还是支持出版的纸质书籍<br>这篇文章等于是对这两本书阅读后做了摘要，方便零基础的用户快速上手ElasticSearch<br><a href="https://github.com/looly/elasticsearch-definitive-guide-cn" target="_blank" rel="external">Elasticsearch 权威指南（中文版）</a><br><a href="https://www.gitbook.com/book/chenryn/kibana-guide-cn/details" target="_blank" rel="external">ELKstack 中文指南（ElasticSearch章节）</a>  </p>
<h3 id="ES-vs-SQL"><a href="#ES-vs-SQL" class="headerlink" title="ES vs SQL"></a>ES vs SQL</h3><table>
<thead>
<tr>
<th>Relational DB</th>
<th>Elasticsearch</th>
</tr>
</thead>
<tbody>
<tr>
<td>Databases</td>
<td>Indices</td>
</tr>
<tr>
<td>Tables</td>
<td>Types</td>
</tr>
<tr>
<td>Rows</td>
<td>Documents</td>
</tr>
<tr>
<td>Columns</td>
<td>Fields</td>
</tr>
</tbody>
</table>
<p>Elasticsearch集群可以包含多个索引(indices)（数据库），每一个索引可以包含多个类型(types)（表），每一个类型包含多个文档(documents)（行），然后每个文档包含多个字段(Fields)（列）。  </p>
<h3 id="“索引”含义的区分"><a href="#“索引”含义的区分" class="headerlink" title="“索引”含义的区分"></a>“索引”含义的区分</h3><p>你可能已经注意到索引(index)这个词在Elasticsearch中有着不同的含义，所以有必要在此做一下区分:  </p>
<ul>
<li>索引（名词） 如上文所述，一个索引(index)就像是传统关系数据库中的数据库，它是相关文档存储的地方，index的复数是indices 或indexes。  </li>
<li>索引（动词） 「索引一个文档」表示把一个文档存储到索引（名词）里，以便它可以被检索或者查询。这很像SQL中的INSERT关键字，差别是，如果文档已经存在，新的文档将覆盖旧的文档。  </li>
<li>倒排索引 传统数据库为特定列增加一个索引，例如B-Tree索引来加速检索。Elasticsearch和Lucene使用一种叫做倒排索引(inverted index)的数据结构来达到相同目的。   </li>
</ul>
<h3 id="Excerise"><a href="#Excerise" class="headerlink" title="Excerise"></a>Excerise</h3><ol>
<li><p>Ping &amp; Server info</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http http://127.0.0.1:9200/</span><br><span class="line">&#123;</span><br><span class="line">    "cluster_name": "elasticsearch", </span><br><span class="line">    "name": "Goliath", </span><br><span class="line">    "status": 200, </span><br><span class="line">    "tagline": "You Know, for Search", </span><br><span class="line">    "version": &#123;</span><br><span class="line">        "build_hash": "c88f77ffc81301dfa9dfd81ca2232f09588bd512", </span><br><span class="line">        "build_snapshot": false, </span><br><span class="line">        "build_timestamp": "2015-02-19T13:05:36Z", </span><br><span class="line">        "lucene_version": "4.10.3", </span><br><span class="line">        "number": "1.4.4"</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>All rows</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http 'http://localhost:9200/_count'                   </span><br><span class="line">&#123;</span><br><span class="line">    "_shards": &#123;</span><br><span class="line">        "failed": 0, </span><br><span class="line">        "successful": 436, </span><br><span class="line">        "total": 436</span><br><span class="line">    &#125;, </span><br><span class="line">    "count": 35672472</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>All indices</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">http <span class="string">'localhost:9200/_cat/indices?v'</span></span><br><span class="line">health status index                pri rep docs<span class="selector-class">.count</span> docs<span class="selector-class">.deleted</span> store<span class="selector-class">.size</span> pri<span class="selector-class">.store</span><span class="selector-class">.size</span> </span><br><span class="line">yellow open   <span class="selector-class">.kibana</span>                <span class="number">1</span>   <span class="number">1</span>         <span class="number">10</span>            <span class="number">2</span>     <span class="number">27.5</span>kb         <span class="number">27.5</span>kb </span><br><span class="line">yellow open   logstash-<span class="number">2016.01</span>.<span class="number">18</span>    <span class="number">5</span>   <span class="number">1</span>     <span class="number">289193</span>            <span class="number">0</span>    <span class="number">170.8</span>mb        <span class="number">170.8</span>mb </span><br><span class="line">yellow open   logstash-<span class="number">2016.03</span>.<span class="number">22</span>    <span class="number">5</span>   <span class="number">1</span>     <span class="number">597585</span>            <span class="number">0</span>    <span class="number">141.1</span>mb        <span class="number">141.1</span>mb </span><br><span class="line">yellow open   logstash-<span class="number">2016.03</span>.<span class="number">17</span>    <span class="number">5</span>   <span class="number">1</span>     <span class="number">582696</span>            <span class="number">0</span>    <span class="number">138.5</span>mb        <span class="number">138.5</span>mb </span><br><span class="line">yellow open   logstash-<span class="number">2016.02</span>.<span class="number">25</span>    <span class="number">5</span>   <span class="number">1</span>     <span class="number">304186</span>            <span class="number">0</span>    <span class="number">103.2</span>mb        <span class="number">103.2</span>mb </span><br><span class="line">yellow open   logstash-<span class="number">2016.02</span>.<span class="number">24</span>    <span class="number">5</span>   <span class="number">1</span>     <span class="number">298755</span>            <span class="number">0</span>    <span class="number">102.5</span>mb        <span class="number">102.5</span>mb</span><br></pre></td></tr></table></figure>
</li>
<li><p>Cluster health</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http '127.0.0.1:9200/_cluster/health?pretty'</span><br><span class="line">&#123;</span><br><span class="line">    "active_primary_shards": 436, </span><br><span class="line">    "active_shards": 436, </span><br><span class="line">    "cluster_name": "elasticsearch", </span><br><span class="line">    "initializing_shards": 0, </span><br><span class="line">    "number_of_data_nodes": 1, </span><br><span class="line">    "number_of_nodes": 1, </span><br><span class="line">    "relocating_shards": 0, </span><br><span class="line">    "status": "yellow", </span><br><span class="line">    "timed_out": false, </span><br><span class="line">    "unassigned_shards": 436</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Nodes list</p>
<figure class="highlight dns"><table><tr><td class="code"><pre><span class="line">http '<span class="number">127.0.0.1</span>:<span class="number">9200</span>/_cat/nodes'</span><br><span class="line"><span class="number">366d</span>cee<span class="number">51992 172.17</span>.<span class="number">5.127 78 80</span> <span class="number">1</span>.<span class="number">21</span> d * Goliath</span><br></pre></td></tr></table></figure>
</li>
<li><p>Task list</p>
<figure class="highlight accesslog"><table><tr><td class="code"><pre><span class="line">http 'http://<span class="number">127.0.0.1:9200</span>/_cluster/pending_tasks'</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"tasks"</span>: <span class="string">[]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Node health<br><strong>jvm</strong></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http '127.0.0.1:9200/_nodes/stats/jvm'</span><br><span class="line">&#123;</span><br><span class="line">    "cluster_name": "elasticsearch", </span><br><span class="line">    "nodes": &#123;</span><br><span class="line">        "vwKzZrSrTDidFr-jtZdRjg": &#123;</span><br><span class="line">            "host": "366dcee51992", </span><br><span class="line">            "ip": [</span><br><span class="line">                "inet[/172.17.5.127:9300]", </span><br><span class="line">                "NONE"</span><br><span class="line">            ], </span><br><span class="line">            "jvm": &#123;</span><br><span class="line">                "buffer_pools": &#123;</span><br><span class="line">                    "direct": &#123;</span><br><span class="line">                        "count": 1610, </span><br><span class="line">                        "total_capacity_in_bytes": 39064123, </span><br><span class="line">                        "used_in_bytes": 39064123</span><br><span class="line">                    &#125;, </span><br><span class="line">                    "mapped": &#123;</span><br><span class="line">                        "count": 2656, </span><br><span class="line">                        "total_capacity_in_bytes": 6260870265, </span><br><span class="line">                        "used_in_bytes": 6260870265</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, </span><br><span class="line">                "gc": &#123;</span><br><span class="line">                    "collectors": &#123;</span><br><span class="line">                        "old": &#123;</span><br><span class="line">                            "collection_count": 20469, </span><br><span class="line">                            "collection_time_in_millis": 1804674</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "young": &#123;</span><br><span class="line">                            "collection_count": 396171, </span><br><span class="line">                            "collection_time_in_millis": 4463746</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, </span><br><span class="line">                "mem": &#123;</span><br><span class="line">                    "heap_committed_in_bytes": 1037959168, </span><br><span class="line">                    "heap_max_in_bytes": 1037959168, </span><br><span class="line">                    "heap_used_in_bytes": 849427344, </span><br><span class="line">                    "heap_used_percent": 81, </span><br><span class="line">                    "non_heap_committed_in_bytes": 85303296, </span><br><span class="line">                    "non_heap_used_in_bytes": 56807912, </span><br><span class="line">                    "pools": &#123;</span><br><span class="line">                        "old": &#123;</span><br><span class="line">                            "max_in_bytes": 715849728, </span><br><span class="line">                            "peak_max_in_bytes": 715849728, </span><br><span class="line">                            "peak_used_in_bytes": 672561680, </span><br><span class="line">                            "used_in_bytes": 602039528</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "survivor": &#123;</span><br><span class="line">                            "max_in_bytes": 35782656, </span><br><span class="line">                            "peak_max_in_bytes": 35782656, </span><br><span class="line">                            "peak_used_in_bytes": 35782656, </span><br><span class="line">                            "used_in_bytes": 6359176</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "young": &#123;</span><br><span class="line">                            "max_in_bytes": 286326784, </span><br><span class="line">                            "peak_max_in_bytes": 286326784, </span><br><span class="line">                            "peak_used_in_bytes": 286326784, </span><br><span class="line">                            "used_in_bytes": 241028640</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, </span><br><span class="line">                "threads": &#123;</span><br><span class="line">                    "count": 130, </span><br><span class="line">                    "peak_count": 135</span><br><span class="line">                &#125;, </span><br><span class="line">                "timestamp": 1459242935482, </span><br><span class="line">                "uptime_in_millis": 2528035636</span><br><span class="line">            &#125;, </span><br><span class="line">            "name": "Goliath", </span><br><span class="line">            "timestamp": 1459242935482, </span><br><span class="line">            "transport_address": "inet[/172.17.5.127:9300]"</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>os</strong></p>
 <figure class="highlight"><table><tr><td class="code"><pre><span class="line">http '127.0.0.1:9200/_nodes/stats/os'</span><br><span class="line">&#123;</span><br><span class="line">    "cluster_name": "elasticsearch", </span><br><span class="line">    "nodes": &#123;</span><br><span class="line">        "vwKzZrSrTDidFr-jtZdRjg": &#123;</span><br><span class="line">            "host": "366dcee51992", </span><br><span class="line">            "ip": [</span><br><span class="line">                "inet[/172.17.5.127:9300]", </span><br><span class="line">                "NONE"</span><br><span class="line">            ], </span><br><span class="line">            "name": "Goliath", </span><br><span class="line">            "os": &#123;</span><br><span class="line">                "cpu": &#123;</span><br><span class="line">                    "idle": 75, </span><br><span class="line">                    "stolen": 0, </span><br><span class="line">                    "sys": 2, </span><br><span class="line">                    "usage": 17, </span><br><span class="line">                    "user": 15</span><br><span class="line">                &#125;, </span><br><span class="line">                "load_average": [</span><br><span class="line">                    3.23, </span><br><span class="line">                    2.33, </span><br><span class="line">                    2.27</span><br><span class="line">                ], </span><br><span class="line">                "mem": &#123;</span><br><span class="line">                    "actual_free_in_bytes": 5407027200, </span><br><span class="line">                    "actual_used_in_bytes": 28110413824, </span><br><span class="line">                    "free_in_bytes": 2586775552, </span><br><span class="line">                    "free_percent": 16, </span><br><span class="line">                    "used_in_bytes": 30930665472, </span><br><span class="line">                    "used_percent": 83</span><br><span class="line">                &#125;, </span><br><span class="line">                "swap": &#123;</span><br><span class="line">                    "free_in_bytes": 7885094912, </span><br><span class="line">                    "used_in_bytes": 8892116992</span><br><span class="line">                &#125;, </span><br><span class="line">                "timestamp": 1459245065474, </span><br><span class="line">                "uptime_in_millis": 21615006</span><br><span class="line">            &#125;, </span><br><span class="line">            "timestamp": 1459245065474, </span><br><span class="line">            "transport_address": "inet[/172.17.5.127:9300]"</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li><p>Index info</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http http://127.0.0.1:9200/logstash-2016.03.29/</span><br><span class="line">&#123;</span><br><span class="line">    "logstash-2016.03.29": &#123;</span><br><span class="line">        "aliases": &#123;&#125;, </span><br><span class="line">        "mappings": &#123;</span><br><span class="line">            "_default_": &#123;</span><br><span class="line">                "_all": &#123;</span><br><span class="line">                    "enabled": true</span><br><span class="line">                &#125;, </span><br><span class="line">                "dynamic_templates": [</span><br><span class="line">                    &#123;</span><br><span class="line">                        "string_fields": &#123;</span><br><span class="line">                            "mapping": &#123;</span><br><span class="line">                                "fields": &#123;</span><br><span class="line">                                    "raw": &#123;</span><br><span class="line">                                        "ignore_above": 256, </span><br><span class="line">                                        "index": "not_analyzed", </span><br><span class="line">                                        "type": "string"</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;, </span><br><span class="line">                                "index": "analyzed", </span><br><span class="line">                                "omit_norms": true, </span><br><span class="line">                                "type": "string"</span><br><span class="line">                            &#125;, </span><br><span class="line">                            "match": "*", </span><br><span class="line">                            "match_mapping_type": "string"</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                ], </span><br><span class="line">                "properties": &#123;</span><br><span class="line">                    "@version": &#123;</span><br><span class="line">                        "index": "not_analyzed", </span><br><span class="line">                        "type": "string"</span><br><span class="line">                    &#125;, </span><br><span class="line">                    "geoip": &#123;</span><br><span class="line">                        "dynamic": "true", </span><br><span class="line">                        "properties": &#123;</span><br><span class="line">                            "location": &#123;</span><br><span class="line">                                "type": "geo_point"</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, </span><br><span class="line">            "syslog": &#123;</span><br><span class="line">                "_all": &#123;</span><br><span class="line">                    "enabled": true</span><br><span class="line">                &#125;, </span><br><span class="line">                "dynamic_templates": [</span><br><span class="line">                    &#123;</span><br><span class="line">                        "string_fields": &#123;</span><br><span class="line">                            "mapping": &#123;</span><br><span class="line">                                "fields": &#123;</span><br><span class="line">                                    "raw": &#123;</span><br><span class="line">                                        "ignore_above": 256, </span><br><span class="line">                                        "index": "not_analyzed", </span><br><span class="line">                                        "type": "string"</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;, </span><br><span class="line">                                "index": "analyzed", </span><br><span class="line">                                "omit_norms": true, </span><br><span class="line">                                "type": "string"</span><br><span class="line">                            &#125;, </span><br><span class="line">                            "match": "*", </span><br><span class="line">                            "match_mapping_type": "string"</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                ], </span><br><span class="line">                "properties": &#123;</span><br><span class="line">                    "@timestamp": &#123;</span><br><span class="line">                        "format": "dateOptionalTime", </span><br><span class="line">                        "type": "date"</span><br><span class="line">                    &#125;, </span><br><span class="line">                    "@version": &#123;</span><br><span class="line">                        "index": "not_analyzed", </span><br><span class="line">                        "type": "string"</span><br><span class="line">                    &#125;, </span><br><span class="line">                    "brief": &#123;</span><br><span class="line">                        "fields": &#123;</span><br><span class="line">                            "raw": &#123;</span><br><span class="line">                                "ignore_above": 256, </span><br><span class="line">                                "index": "not_analyzed", </span><br><span class="line">                                "type": "string"</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "norms": &#123;</span><br><span class="line">                            "enabled": false</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "type": "string"</span><br><span class="line">                    &#125;, </span><br><span class="line">                    "count": &#123;</span><br><span class="line">                        "fields": &#123;</span><br><span class="line">                            "raw": &#123;</span><br><span class="line">                                "ignore_above": 256, </span><br><span class="line">                                "index": "not_analyzed", </span><br><span class="line">                                "type": "string"</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "norms": &#123;</span><br><span class="line">                            "enabled": false</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "type": "string"</span><br><span class="line">                    &#125;, </span><br><span class="line">                    "geoip": &#123;</span><br><span class="line">                        "dynamic": "true", </span><br><span class="line">                        "properties": &#123;</span><br><span class="line">                            "location": &#123;</span><br><span class="line">                                "type": "geo_point"</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;, </span><br><span class="line">                    "host": &#123;</span><br><span class="line">                        "fields": &#123;</span><br><span class="line">                            "raw": &#123;</span><br><span class="line">                                "ignore_above": 256, </span><br><span class="line">                                "index": "not_analyzed", </span><br><span class="line">                                "type": "string"</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "norms": &#123;</span><br><span class="line">                            "enabled": false</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "type": "string"</span><br><span class="line">                    &#125;, </span><br><span class="line">                    "hostname": &#123;</span><br><span class="line">                        "fields": &#123;</span><br><span class="line">                            "raw": &#123;</span><br><span class="line">                                "ignore_above": 256, </span><br><span class="line">                                "index": "not_analyzed", </span><br><span class="line">                                "type": "string"</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "norms": &#123;</span><br><span class="line">                            "enabled": false</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "type": "string"</span><br><span class="line">                    &#125;, </span><br><span class="line">                    "info": &#123;</span><br><span class="line">                        "fields": &#123;</span><br><span class="line">                            "raw": &#123;</span><br><span class="line">                                "ignore_above": 256, </span><br><span class="line">                                "index": "not_analyzed", </span><br><span class="line">                                "type": "string"</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "norms": &#123;</span><br><span class="line">                            "enabled": false</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "type": "string"</span><br><span class="line">                    &#125;, </span><br><span class="line">                    "log_type": &#123;</span><br><span class="line">                        "fields": &#123;</span><br><span class="line">                            "raw": &#123;</span><br><span class="line">                                "ignore_above": 256, </span><br><span class="line">                                "index": "not_analyzed", </span><br><span class="line">                                "type": "string"</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "norms": &#123;</span><br><span class="line">                            "enabled": false</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "type": "string"</span><br><span class="line">                    &#125;, </span><br><span class="line">                    "module": &#123;</span><br><span class="line">                        "fields": &#123;</span><br><span class="line">                            "raw": &#123;</span><br><span class="line">                                "ignore_above": 256, </span><br><span class="line">                                "index": "not_analyzed", </span><br><span class="line">                                "type": "string"</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "norms": &#123;</span><br><span class="line">                            "enabled": false</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "type": "string"</span><br><span class="line">                    &#125;, </span><br><span class="line">                    "msg": &#123;</span><br><span class="line">                        "fields": &#123;</span><br><span class="line">                            "raw": &#123;</span><br><span class="line">                                "ignore_above": 256, </span><br><span class="line">                                "index": "not_analyzed", </span><br><span class="line">                                "type": "string"</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "norms": &#123;</span><br><span class="line">                            "enabled": false</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "type": "string"</span><br><span class="line">                    &#125;, </span><br><span class="line">                    "oid": &#123;</span><br><span class="line">                        "fields": &#123;</span><br><span class="line">                            "raw": &#123;</span><br><span class="line">                                "ignore_above": 256, </span><br><span class="line">                                "index": "not_analyzed", </span><br><span class="line">                                "type": "string"</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "norms": &#123;</span><br><span class="line">                            "enabled": false</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "type": "string"</span><br><span class="line">                    &#125;, </span><br><span class="line">                    "serverity": &#123;</span><br><span class="line">                        "type": "long"</span><br><span class="line">                    &#125;, </span><br><span class="line">                    "severity": &#123;</span><br><span class="line">                        "fields": &#123;</span><br><span class="line">                            "raw": &#123;</span><br><span class="line">                                "ignore_above": 256, </span><br><span class="line">                                "index": "not_analyzed", </span><br><span class="line">                                "type": "string"</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "norms": &#123;</span><br><span class="line">                            "enabled": false</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "type": "string"</span><br><span class="line">                    &#125;, </span><br><span class="line">                    "status": &#123;</span><br><span class="line">                        "fields": &#123;</span><br><span class="line">                            "raw": &#123;</span><br><span class="line">                                "ignore_above": 256, </span><br><span class="line">                                "index": "not_analyzed", </span><br><span class="line">                                "type": "string"</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "norms": &#123;</span><br><span class="line">                            "enabled": false</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "type": "string"</span><br><span class="line">                    &#125;, </span><br><span class="line">                    "syslog5424_pri": &#123;</span><br><span class="line">                        "fields": &#123;</span><br><span class="line">                            "raw": &#123;</span><br><span class="line">                                "ignore_above": 256, </span><br><span class="line">                                "index": "not_analyzed", </span><br><span class="line">                                "type": "string"</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "norms": &#123;</span><br><span class="line">                            "enabled": false</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "type": "string"</span><br><span class="line">                    &#125;, </span><br><span class="line">                    "syslog_facility": &#123;</span><br><span class="line">                        "fields": &#123;</span><br><span class="line">                            "raw": &#123;</span><br><span class="line">                                "ignore_above": 256, </span><br><span class="line">                                "index": "not_analyzed", </span><br><span class="line">                                "type": "string"</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "norms": &#123;</span><br><span class="line">                            "enabled": false</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "type": "string"</span><br><span class="line">                    &#125;, </span><br><span class="line">                    "syslog_facility_code": &#123;</span><br><span class="line">                        "type": "long"</span><br><span class="line">                    &#125;, </span><br><span class="line">                    "syslog_message": &#123;</span><br><span class="line">                        "fields": &#123;</span><br><span class="line">                            "raw": &#123;</span><br><span class="line">                                "ignore_above": 256, </span><br><span class="line">                                "index": "not_analyzed", </span><br><span class="line">                                "type": "string"</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "norms": &#123;</span><br><span class="line">                            "enabled": false</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "type": "string"</span><br><span class="line">                    &#125;, </span><br><span class="line">                    "syslog_program": &#123;</span><br><span class="line">                        "fields": &#123;</span><br><span class="line">                            "raw": &#123;</span><br><span class="line">                                "ignore_above": 256, </span><br><span class="line">                                "index": "not_analyzed", </span><br><span class="line">                                "type": "string"</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "norms": &#123;</span><br><span class="line">                            "enabled": false</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "type": "string"</span><br><span class="line">                    &#125;, </span><br><span class="line">                    "syslog_severity": &#123;</span><br><span class="line">                        "fields": &#123;</span><br><span class="line">                            "raw": &#123;</span><br><span class="line">                                "ignore_above": 256, </span><br><span class="line">                                "index": "not_analyzed", </span><br><span class="line">                                "type": "string"</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "norms": &#123;</span><br><span class="line">                            "enabled": false</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "type": "string"</span><br><span class="line">                    &#125;, </span><br><span class="line">                    "syslog_severity_code": &#123;</span><br><span class="line">                        "type": "long"</span><br><span class="line">                    &#125;, </span><br><span class="line">                    "tags": &#123;</span><br><span class="line">                        "fields": &#123;</span><br><span class="line">                            "raw": &#123;</span><br><span class="line">                                "ignore_above": 256, </span><br><span class="line">                                "index": "not_analyzed", </span><br><span class="line">                                "type": "string"</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "norms": &#123;</span><br><span class="line">                            "enabled": false</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "type": "string"</span><br><span class="line">                    &#125;, </span><br><span class="line">                    "timestamp": &#123;</span><br><span class="line">                        "fields": &#123;</span><br><span class="line">                            "raw": &#123;</span><br><span class="line">                                "ignore_above": 256, </span><br><span class="line">                                "index": "not_analyzed", </span><br><span class="line">                                "type": "string"</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "norms": &#123;</span><br><span class="line">                            "enabled": false</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "type": "string"</span><br><span class="line">                    &#125;, </span><br><span class="line">                    "type": &#123;</span><br><span class="line">                        "fields": &#123;</span><br><span class="line">                            "raw": &#123;</span><br><span class="line">                                "ignore_above": 256, </span><br><span class="line">                                "index": "not_analyzed", </span><br><span class="line">                                "type": "string"</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "norms": &#123;</span><br><span class="line">                            "enabled": false</span><br><span class="line">                        &#125;, </span><br><span class="line">                        "type": "string"</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        "settings": &#123;</span><br><span class="line">            "index": &#123;</span><br><span class="line">                "creation_date": "1459189864276", </span><br><span class="line">                "number_of_replicas": "1", </span><br><span class="line">                "number_of_shards": "5", </span><br><span class="line">                "refresh_interval": "5s", </span><br><span class="line">                "uuid": "qUZ_ZY3_RPOdhrdJ5mi32A", </span><br><span class="line">                "version": &#123;</span><br><span class="line">                    "created": "1040499"</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        "warmers": &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="cat-接口的命令行使用"><a href="#cat-接口的命令行使用" class="headerlink" title="cat 接口的命令行使用"></a>cat 接口的命令行使用</h3><p>之前介绍的各种接口数据，其响应数据都是 JSON 格式，更适用于程序处理。对于我们日常运维，在 Linux 命令行终端环境来说，简单的分行和分列表格才是更方便的样式。为此，Elasticsearch 提供了 cat 接口。</p>
<p>cat 接口可以读取各种监控数据，可用接口列表如下：</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="regexp">/_cat/</span>allocation</span><br><span class="line"><span class="regexp">/_cat/</span>shards</span><br><span class="line"><span class="regexp">/_cat/</span>shards/&#123;index&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>master</span><br><span class="line"><span class="regexp">/_cat/</span>nodes</span><br><span class="line"><span class="regexp">/_cat/</span>indices</span><br><span class="line"><span class="regexp">/_cat/</span>indices/&#123;index&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>segments</span><br><span class="line"><span class="regexp">/_cat/</span>segments/&#123;index&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>count</span><br><span class="line"><span class="regexp">/_cat/</span>count/&#123;index&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>recovery</span><br><span class="line"><span class="regexp">/_cat/</span>recovery/&#123;index&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>health</span><br><span class="line"><span class="regexp">/_cat/</span>pending_tasks</span><br><span class="line"><span class="regexp">/_cat/</span>aliases</span><br><span class="line"><span class="regexp">/_cat/</span>aliases/&#123;alias&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>thread_pool</span><br><span class="line"><span class="regexp">/_cat/</span>plugins</span><br><span class="line"><span class="regexp">/_cat/</span>fielddata</span><br><span class="line"><span class="regexp">/_cat/</span>fielddata/&#123;fields&#125;</span><br></pre></td></tr></table></figure>
<h3 id="增删改查"><a href="#增删改查" class="headerlink" title="增删改查"></a>增删改查</h3><p>增删改查是数据库的基础操作方法。ES 虽然不是数据库，但是很多场合下，都被人们当做一个文档型 NoSQL 数据库在使用，原因自然是因为在接口和分布式架构层面的相似性。虽然在 ELKstack 场景下，数据的写入和查询，分别由 Logstash 和 Kibana 代劳，作为测试、调研和排错时的基本功，还是需要了解一下 ES 的增删改查用法的。</p>
<h3 id="数据写入"><a href="#数据写入" class="headerlink" title="数据写入"></a>数据写入</h3><p>ES 的一大特点，就是全 RESTful 接口处理 JSON 请求。所以，数据写入非常简单：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">curl -XPOST http://127.0.0.1:9200/logstash-2015.06.21/testlog -d '&#123;</span><br><span class="line">    "date" : "1434966686000",</span><br><span class="line">    "user" : "chenlin7",</span><br><span class="line">    "mesg" : "first message into Elasticsearch"</span><br><span class="line">&#125;'</span><br></pre></td></tr></table></figure>
<p>命令返回响应结果为：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">"_index"</span>:<span class="string">"logstash-2015.06.21"</span>,<span class="attr">"_type"</span>:<span class="string">"testlog"</span>,<span class="attr">"_id"</span>:<span class="string">"AU4ew3h2nBE6n0qcyVJK"</span>,<span class="attr">"_version"</span>:<span class="number">1</span>,<span class="attr">"created"</span>:<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure>
<h3 id="数据获取"><a href="#数据获取" class="headerlink" title="数据获取"></a>数据获取</h3><p>“可以看到，在数据写入的时候，会返回该数据的 _id。这就是后续用来获取数据的关键：</p>
<p><code>curl -XGET http://127.0.0.1:9200/logstash-2015.06.21/testlog/AU4ew3h2nBE6n0qcyVJK</code><br>命令返回响应结果为：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">"_index"</span>:<span class="string">"logstash-2015.06.21"</span>,<span class="attr">"_type"</span>:<span class="string">"testlog"</span>,<span class="attr">"_id"</span>:<span class="string">"AU4ew3h2nBE6n0qcyVJK"</span>,<span class="attr">"_version"</span>:<span class="number">1</span>,<span class="attr">"found"</span>:<span class="literal">true</span>,<span class="attr">"_source"</span>:&#123;</span><br><span class="line">    <span class="attr">"date"</span> : <span class="string">"1434966686000"</span>,</span><br><span class="line">    <span class="attr">"user"</span> : <span class="string">"chenlin7"</span>,</span><br><span class="line">    <span class="attr">"mesg"</span> : <span class="string">"first message into Elasticsearch"</span></span><br><span class="line">&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>这个 _source 里的内容，正是之前写入的数据。</p>
<p>如果觉得这个返回看起来有点太过麻烦，可以使用<br><code>curl -XGET http://127.0.0.1:9200/logstash-2015.06.21/testlog/AU4ew3h2nBE6n0qcyVJK/_source</code><br>来指明只获取源数据部分。</p>
<p>更进一步的，如果你只想看数据中的一部分字段内容，可以使用<br><code>curl -XGET http://127.0.0.1:9200/logstash-2015.06.21/testlog/AU4ew3h2nBE6n0qcyVJK?fields=user,mesg</code><br>来指明获取字段，结果如下：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">"_index"</span>:<span class="string">"logstash-2015.06.21"</span>,<span class="attr">"_type"</span>:<span class="string">"testlog"</span>,<span class="attr">"_id"</span>:<span class="string">"AU4ew3h2nBE6n0qcyVJK"</span>,<span class="attr">"_version"</span>:<span class="number">1</span>,<span class="attr">"found"</span>:<span class="literal">true</span>,<span class="attr">"fields"</span>:&#123;<span class="attr">"user"</span>:[<span class="string">"chenlin7"</span>],<span class="attr">"mesg"</span>:[<span class="string">"first message into Elasticsearch"</span>]&#125;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="数据删除"><a href="#数据删除" class="headerlink" title="数据删除"></a>数据删除</h3><p>要删除数据，修改发送的 HTTP 请求方法为 DELETE 即可：<br><code>curl -XDELETE http://127.0.0.1:9200/logstash-2015.06.21/testlog/AU4ew3h2nBE6n0qcyVJK</code><br>删除不单针对单条数据，还可以删除整个 type，乃至整个索引。甚至可以用通配符。<br><code>curl -XDELETE http://127.0.0.1:9200/logstash-2015.06.0*</code></p>
<h3 id="数据更新"><a href="#数据更新" class="headerlink" title="数据更新"></a>数据更新</h3><p>已经写过的数据，同样还是可以修改的。有两种办法，一种是全量提交，即指明 _id 再发送一次写入请求。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">curl -XPOST http://127.0.0.1:9200/logstash-2015.06.21/testlog/AU4ew3h2nBE6n0qcyVJK -d '&#123;</span><br><span class="line">    "date" : "1434966686000",</span><br><span class="line">    "user" : "chenlin7",</span><br><span class="line">    "mesg" " "first message into Elasticsearch but version 2"</span><br><span class="line">&#125;'</span><br></pre></td></tr></table></figure>
<p>另一种是局部更新，使用 /_update 接口：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">curl -XPOST 'http://127.0.0.1:9200/logstash-2015.06.21/testlog/AU4ew3h2nBE6n0qcyVJK/_update' -d '&#123;</span><br><span class="line">    "doc" : &#123;</span><br><span class="line">        "user" : "someone"</span><br><span class="line">    &#125;</span><br><span class="line">&#125;'</span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">curl -XPOST 'http://127.0.0.1:9200/logstash-2015.06.21/testlog/AU4ew3h2nBE6n0qcyVJK/_update' -d '&#123;</span><br><span class="line">    "script" : "ctx._source.user = \"someone\""</span><br><span class="line">&#125;'</span><br></pre></td></tr></table></figure>
<h3 id="搜索请求"><a href="#搜索请求" class="headerlink" title="搜索请求"></a>搜索请求</h3><p>上节介绍的，都是针对单条数据的操作。在 ES 环境中，更多的是搜索和聚合请求。在之前章节中，我们也介绍过数据获取和数据搜索的一点区别：==刚写入的数据，可以通过 translog 立刻获取；但是却要等到 refresh 成为一个 segment 后，才能被搜索到。==本节就介绍一下 ES 的搜索语法。</p>
<h3 id="全文搜索"><a href="#全文搜索" class="headerlink" title="全文搜索"></a>全文搜索</h3><p>ES 对搜索请求，有简易语法和完整语法两种方式。简易语法作为以后在 Kibana 上最常用的方式，一定是需要学会的。而在命令行里，我们可以通过最简单的方式来做到。还是上节输入的数据：<br><code>curl -XGET http://127.0.0.1:9200/logstash-2015.06.21/testlog/_search?q=first</code><br>可以看到返回结果：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">"took"</span>:<span class="number">240</span>,<span class="attr">"timed_out"</span>:<span class="literal">false</span>,<span class="attr">"_shards"</span>:&#123;<span class="attr">"total"</span>:<span class="number">27</span>,<span class="attr">"successful"</span>:<span class="number">27</span>,<span class="attr">"failed"</span>:<span class="number">0</span>&#125;,<span class="attr">"hits"</span>:&#123;<span class="attr">"total"</span>:<span class="number">1</span>,<span class="attr">"max_score"</span>:<span class="number">0.11506981</span>,<span class="attr">"hits"</span>:[&#123;<span class="attr">"_index"</span>:<span class="string">"logstash-2015.06.21"</span>,<span class="attr">"_type"</span>:<span class="string">"testlog"</span>,<span class="attr">"_id"</span>:<span class="string">"AU4ew3h2nBE6n0qcyVJK"</span>,<span class="attr">"_score"</span>:<span class="number">0.11506981</span>,<span class="attr">"_source"</span>:&#123;</span><br><span class="line">    <span class="attr">"date"</span> : <span class="string">"1434966686000"</span>,</span><br><span class="line">    <span class="attr">"user"</span> : <span class="string">"chenlin7"</span>,</span><br><span class="line">    <span class="attr">"mesg"</span> : <span class="string">"first message into Elasticsearch"</span></span><br><span class="line">&#125;&#125;]&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>还可以用下面语句搜索，结果是一样的。<br><code>curl -XGET http://127.0.0.1:9200/logstash-2015.06.21/testlog/_search?q=user:&quot;chenlin7</code></p>
<p>Excerpt From: 饶琛琳. “ELKstack 中文指南.” iBooks. </p>
<h3 id="querystring-语法"><a href="#querystring-语法" class="headerlink" title="querystring 语法"></a>querystring 语法</h3><p><code>curl -XGET http://127.0.0.1:9200/logstash-2016.03.29/_search?q=first</code></p>
<p>上例中，<code>?q=</code>后面写的，就是 querystring 语法。鉴于这部分内容会在 Kibana 上经常使用，这里详细解析一下语法：  </p>
<ul>
<li><strong>全文检索</strong>：直接写搜索的单词，如上例中的 <code>first</code>；</li>
<li><strong>单字段的全文检索</strong>：在搜索单词之前加上字段名和冒号，比如如果知道单词 first 肯定出现在 mesg 字段，可以写作 <code>mesg:first</code>；</li>
<li><strong>单字段的精确检索</strong>：在搜索单词前后加双引号，比如 <code>user:&quot;chenlin7&quot;</code>；<br>多个检索条件的组合：可以使用 NOT, AND 和 OR 来组合检索，注意必须是大写。比如 <code>user:(&quot;chenlin7&quot; OR &quot;chenlin&quot;) AND NOT mesg:first</code>；</li>
<li><strong>字段是否存在</strong>：<code>_exists_:user</code> 表示要求 user 字段存在，<code>_missing_:user</code> 表示要求 user 字段不存在；</li>
<li><strong>通配符</strong>：用 ? 表示单字母，<em> 表示任意个字母。比如 `fir?t mess</em>`；</li>
<li><strong>正则</strong>：需要比通配符更复杂一点的表达式，可以使用正则。比如 <code>mesg:/mes{2}ages?/</code>。注意 ES 中正则性能很差，而且支持的功能也不是特别强大，尽量不要使用。ES 支持的正则语法见：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-regexp-query.html#regexp-syntax" target="_blank" rel="external">query-dsl-regexp-query.html</a></li>
<li><strong>近似搜索</strong>：用 ~ 表示搜索单词可能有一两个字母写的不对，请 ES 按照相似度返回结果。比如 <code>frist~</code>；</li>
<li><strong>范围搜索</strong>：对数值和时间，ES 都可以使用范围搜索，比如：<code>rtt:&gt;300</code>，<code>date:[&quot;now-6h&quot; TO &quot;now&quot;}</code> 等。其中，<code>[]</code> 表示端点数值包含在范围内，<code>{}</code> 表示端点数值不包含在范围内；</li>
</ul>
<h3 id="完整语法"><a href="#完整语法" class="headerlink" title="完整语法"></a>完整语法</h3><p>ES 支持各种类型的检索请求，除了可以用 querystring 语法表达的以外，还有很多其他类型，具体列表和示例可参见：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-queries.html" target="_blank" rel="external">query-dsl-regexp-query.html</a>。</p>
<p>作为最简单和常用的示例，这里展示一下 term query 的写法，相当于 querystring 语法中的 <code>user:&quot;chenlin7&quot;</code>：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">curl -XGET http://127.0.0.1:9200/_search -d '</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "term": &#123;</span><br><span class="line">      "user": "chenlin7" </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;'</span><br></pre></td></tr></table></figure>
<h3 id="聚合请求"><a href="#聚合请求" class="headerlink" title="聚合请求"></a>聚合请求</h3><p>在检索范围确定之后，ES 还支持对结果集做聚合查询，返回更直接的聚合统计结果。在 ES 1.0 版本之前，这个接口叫 Facet，1.0 版本之后，这个接口改为 Aggregation。</p>
<p>Kibana 分别在 v3 中使用 Facet，v4 中使用 Aggregation。不过总的来说，Aggregation 是 Facet 接口的强化升级版本，我们直接了解 Aggregation 即可。本书后续章节也会介绍如何在 Kibana 的 v3 版本中使用 aggregation 接口做二次开发。</p>
<p>Aggregation 分为 bucket 和 metric 两种，分别用作词元划分和数值计算。而其中的 bucket aggregation，还支持在自身结果集的基础上，叠加新的 aggregation。这就是 aggregation 比 facet 最领先的地方。比如实现一个时序百分比统计，在 facet 接口就无法直接完成，而在 aggregation 接口就很简单了：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"># curl -XPOST 'http://127.0.0.1:9200/logstash-2015.06.22/_search?size=0&amp;pretty' -d'&#123;</span><br><span class="line">    "aggs" : &#123;</span><br><span class="line">        "percentile_over_time" : &#123;</span><br><span class="line">            "date_histogram" : &#123;</span><br><span class="line">                "field"    : "@timestamp",</span><br><span class="line">                "interval" : "1h"</span><br><span class="line">            &#125;,</span><br><span class="line">            "aggs" : &#123;</span><br><span class="line">                "percentile_one_time" : &#123;</span><br><span class="line">                    "percentiles" : &#123;</span><br><span class="line">                        "field" : "requesttime"</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;'</span><br></pre></td></tr></table></figure>
<p>得到结果如下：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"took"</span> : <span class="number">151595</span>,</span><br><span class="line">  <span class="attr">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"_shards"</span> : &#123;</span><br><span class="line">    <span class="attr">"total"</span> : <span class="number">81</span>,</span><br><span class="line">    <span class="attr">"successful"</span> : <span class="number">81</span>,</span><br><span class="line">    <span class="attr">"failed"</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"hits"</span> : &#123;</span><br><span class="line">    <span class="attr">"total"</span> : <span class="number">3307142043</span>,</span><br><span class="line">    <span class="attr">"max_score"</span> : <span class="number">1.0</span>,</span><br><span class="line">    <span class="attr">"hits"</span> : [ ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"aggregations"</span> : &#123;</span><br><span class="line">    <span class="attr">"percentile_over_time"</span> : &#123;</span><br><span class="line">      <span class="attr">"buckets"</span> : [ &#123;</span><br><span class="line">        <span class="attr">"key_as_string"</span> : <span class="string">"22/Jun/2015:22:00:00 +0000"</span>,</span><br><span class="line">        <span class="attr">"key"</span> : <span class="number">1435010400000</span>,</span><br><span class="line">        <span class="attr">"doc_count"</span> : <span class="number">459273981</span>,</span><br><span class="line">        <span class="attr">"percentile_one_time"</span> : &#123;</span><br><span class="line">          <span class="attr">"values"</span> : &#123;</span><br><span class="line">            <span class="attr">"1.0"</span> : <span class="number">0.004</span>,</span><br><span class="line">            <span class="attr">"5.0"</span> : <span class="number">0.006</span>,</span><br><span class="line">            <span class="attr">"25.0"</span> : <span class="number">0.023</span>,</span><br><span class="line">            <span class="attr">"50.0"</span> : <span class="number">0.035</span>,</span><br><span class="line">            <span class="attr">"75.0"</span> : <span class="number">0.08774675719725569</span>,</span><br><span class="line">            <span class="attr">"95.0"</span> : <span class="number">0.25732934416125663</span>,</span><br><span class="line">            <span class="attr">"99.0"</span> : <span class="number">0.7508899754871812</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, &#123;</span><br><span class="line">        <span class="attr">"key_as_string"</span> : <span class="string">"23/Jun/2015:00:00:00 +0000"</span>,</span><br><span class="line">        <span class="attr">"key"</span> : <span class="number">1435017600000</span>,</span><br><span class="line">        <span class="attr">"doc_count"</span> : <span class="number">768620219</span>,</span><br><span class="line">        <span class="attr">"percentile_one_time"</span> : &#123;</span><br><span class="line">          <span class="attr">"values"</span> : &#123;</span><br><span class="line">            <span class="attr">"1.0"</span> : <span class="number">0.004</span>,</span><br><span class="line">            <span class="attr">"5.0"</span> : <span class="number">0.007000000000000001</span>,</span><br><span class="line">            <span class="attr">"25.0"</span> : <span class="number">0.025</span>,</span><br><span class="line">            <span class="attr">"50.0"</span> : <span class="number">0.03987809503972864</span>,</span><br><span class="line">            <span class="attr">"75.0"</span> : <span class="number">0.10297843567746187</span>,</span><br><span class="line">            <span class="attr">"95.0"</span> : <span class="number">0.30047269327062875</span>,</span><br><span class="line">            <span class="attr">"99.0"</span> : <span class="number">1.015495933753329</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, &#123;</span><br><span class="line">        <span class="attr">"key_as_string"</span> : <span class="string">"23/Jun/2015:02:00:00 +0000"</span>,</span><br><span class="line">        <span class="attr">"key"</span> : <span class="number">1435024800000</span>,</span><br><span class="line">        <span class="attr">"doc_count"</span> : <span class="number">849467060</span>,</span><br><span class="line">        <span class="attr">"percentile_one_time"</span> : &#123;</span><br><span class="line">          <span class="attr">"values"</span> : &#123;</span><br><span class="line">            <span class="attr">"1.0"</span> : <span class="number">0.004</span>,</span><br><span class="line">            <span class="attr">"5.0"</span> : <span class="number">0.008</span>,</span><br><span class="line">            <span class="attr">"25.0"</span> : <span class="number">0.027000000000000003</span>,</span><br><span class="line">            <span class="attr">"50.0"</span> : <span class="number">0.0439999899006102</span>,</span><br><span class="line">            <span class="attr">"75.0"</span> : <span class="number">0.1160416197625958</span>,</span><br><span class="line">            <span class="attr">"95.0"</span> : <span class="number">0.3383140614483838</span>,</span><br><span class="line">            <span class="attr">"99.0"</span> : <span class="number">1.0275839684542212</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ES 目前能支持的聚合请求列表，参见：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html" target="_blank" rel="external">search-aggregations.html</a></p>
<h3 id="GC"><a href="#GC" class="headerlink" title="GC"></a>GC</h3><p>对不了解 JVM 的 GC 的读者，这里先介绍一下 GC(垃圾收集)以及 GC 对 Elasticsearch 的影响。</p>
<p>Java is a garbage-collected language, which means that the programmer does not manually manage memory allocation and deallocation. The programmer simply writes code, and the Java Virtual Machine (JVM) manages the process of allocating memory as needed, and then later cleaning up that memory when no longer needed. Java 是一个自动垃圾收集的编程语言，启动 JVM 虚拟机的时候，会分配到固定大小的内存块，这个块叫做 heap(堆)。JVM 会把 heap 分成两个组：</p>
<ul>
<li>Young 新实例化的对象所分配的空间。这个空间一般来说只有 100MB 到 500MB 大小。Young 空间又分为两个 survivor(幸存)空间。当 Young 空间满，就会发生一次 young gc，还存活的对象，就被移入幸存空间里，已失效的对象则被移除。</li>
<li>Old 老对象存储的空间。这些对象应该是长期存活而且在较长一段时间内不会变化的内容。“这个空间会大很多，在 ES 来说，一节点上可能就有 30GB 内存是这个空间。前面提到的 young gc 中，如果某个对象连续多次幸存下来，就会被移进 Old 空间内。而等到 Old 空间满，就会发生一次 old gc，把失效对象移除。<br>听起来很美好的样子，但是这些都是有代价的！在 GC 发生的时候，JVM 需要暂停程序运行，以便自己追踪对象图收集全部失效对象。在这期间，其他一切都不会继续运行。请求没有响应，ping 没有应答，分片不会分配……</li>
</ul>
<p>当然，young gc 一般来说执行极快，没太大影响。但是 old 空间那么大，稍慢一点的 gc 就意味着程序几秒乃至十几秒的不可用，这太危险了。</p>
<p>JVM 本身对 gc 算法一直在努力优化，Elasticsearch 也尽量复用内部对象，复用网络缓冲，然后还提供像 Doc Values 这样的特性。但不管怎么说，gc 性能总是我们需要密切关注的数据，因为它是集群稳定性最大的影响因子。</p>
<p>如果你的 ES 集群监控里发现经常有很耗时的 GC，说明集群负载很重，内存不足。严重情况下，这些 GC 导致节点无法正确响应集群之间的 ping ，可能就直接从集群里退出了。然后数据分片也随之在集群中重新迁移，引发更大的网络和磁盘 IO，正常的写入和搜索也会受到影响。</p>
<h3 id="查询慢"><a href="#查询慢" class="headerlink" title="查询慢"></a>查询慢</h3><p>更常见的可能，是集群存储长期数据导致索引映射数据确实大到了 master 节点内存不足以快速处理的地步。</p>
<p>这时候，根据实际情况，可以有以下几种选择：</p>
<p>索引就是特别多：给 master 加内存。<br>索引里字段太多：改用 nested object 方式节省字段数量。<br>索引多到内存就是不够了：把一部分数据拆出来另一个集群。</p>
<h3 id="Web-Console"><a href="#Web-Console" class="headerlink" title="Web Console"></a>Web Console</h3><p><a href="https://github.com/lmenezes/elasticsearch-kopf" target="_blank" rel="external">elasticsearch-kopf</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.wuliwala.net/2016/03/29/learning-elasticsearch/" data-id="cingzfkyz000x6l5okmo80mz2" class="article-share-link">Share</a>
      
        <a href="http://blog.wuliwala.net/2016/03/29/learning-elasticsearch/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dev/">dev</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/elk/">elk</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nosql/">nosql</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/search/">search</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/04/07/supermicro_auto_deploy/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          SuperMicro Auto Deploy
        
      </div>
    </a>
  
  
    <a href="/2016/03/19/segmentfault-tools-sharing/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">segmentfault「我是工具控」分享</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/04/21/dcos_installation/">DC/OS Deployment</a>
          </li>
        
          <li>
            <a href="/2016/04/21/using_nxlog_to_send_windows_event_logs_to_logstash/">Using NxLog to send Windows Event Logs to Logstash</a>
          </li>
        
          <li>
            <a href="/2016/04/12/upgrade_influxdb_from_v0.9_to_v0.10/">Upgrade influxdb from v0.9 to v0.12</a>
          </li>
        
          <li>
            <a href="/2016/04/07/supermicro_auto_deploy/">SuperMicro Auto Deploy</a>
          </li>
        
          <li>
            <a href="/2016/03/29/learning-elasticsearch/">Learning ElasticSearch</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/app/" style="font-size: 10px;">app</a> <a href="/tags/dcos/" style="font-size: 10px;">dcos</a> <a href="/tags/dev/" style="font-size: 20px;">dev</a> <a href="/tags/devops/" style="font-size: 15px;">devops</a> <a href="/tags/dhcp/" style="font-size: 10px;">dhcp</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/elk/" style="font-size: 15px;">elk</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/graphing/" style="font-size: 10px;">graphing</a> <a href="/tags/influxdb/" style="font-size: 10px;">influxdb</a> <a href="/tags/ionic/" style="font-size: 10px;">ionic</a> <a href="/tags/ipmi/" style="font-size: 10px;">ipmi</a> <a href="/tags/logstash/" style="font-size: 10px;">logstash</a> <a href="/tags/mesos/" style="font-size: 10px;">mesos</a> <a href="/tags/monitoring/" style="font-size: 15px;">monitoring</a> <a href="/tags/nosql/" style="font-size: 10px;">nosql</a> <a href="/tags/nxlog/" style="font-size: 10px;">nxlog</a> <a href="/tags/pxe/" style="font-size: 10px;">pxe</a> <a href="/tags/search/" style="font-size: 10px;">search</a> <a href="/tags/sysops/" style="font-size: 15px;">sysops</a> <a href="/tags/tools/" style="font-size: 10px;">tools</a> <a href="/tags/windows/" style="font-size: 10px;">windows</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/app/">app</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dcos/">dcos</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dev/">dev</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/devops/">devops</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dhcp/">dhcp</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/elk/">elk</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/graphing/">graphing</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/influxdb/">influxdb</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ionic/">ionic</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ipmi/">ipmi</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/logstash/">logstash</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mesos/">mesos</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/monitoring/">monitoring</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nosql/">nosql</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nxlog/">nxlog</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pxe/">pxe</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/search/">search</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sysops/">sysops</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tools/">tools</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows/">windows</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">January 2015</a><span class="archive-list-count">3</span></li></ul>
    </div>
  </div>


  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 arkii<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="http://blog.wuliwala.net" class="mobile-nav-link">Home</a>
  
    <a href="http://blog.wuliwala.net/archives" class="mobile-nav-link">Archives</a>
  
    <a href="http://blog.wuliwala.net/about" class="mobile-nav-link">About</a>
  
    <a href="https://github.com/arkii" class="mobile-nav-link">GitHub</a>
  
    <a href="https://hub.docker.com/u/arkii" class="mobile-nav-link">DockerHub</a>
  
</nav>
    
<script>
  var disqus_shortname = 'blog-arkii';
  
  var disqus_url = 'http://blog.wuliwala.net/2016/03/29/learning-elasticsearch/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script> -->
<script src="//ajax.useso.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>